<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teamleader OAuth Callback</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        .icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        .icon-loading {
            background: #e3f2fd;
            animation: pulse 1.5s ease-in-out infinite;
        }
        .icon-success {
            background: #e8f5e9;
        }
        .icon-error {
            background: #ffebee;
        }
        .icon-manual {
            background: #fff3e0;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        h1 {
            color: #1a1a2e;
            font-size: 24px;
            margin-bottom: 12px;
        }
        p {
            color: #4a4a68;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .code-container {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }
        .code-input {
            width: 100%;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            text-align: center;
            margin-bottom: 12px;
        }
        .btn {
            display: inline-block;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a6fd6;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            margin-left: 8px;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        .copied {
            color: #4caf50;
            font-weight: 600;
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .copied.show {
            opacity: 1;
        }
        .error-details {
            background: #fff8f8;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            text-align: left;
            font-size: 14px;
            color: #c62828;
        }
        .hidden {
            display: none !important;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e3f2fd;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loading">
            <div class="icon icon-loading">
                <div class="spinner"></div>
            </div>
            <h1>Traitement en cours...</h1>
            <p>Veuillez patienter pendant que nous finalisons votre authentification Teamleader.</p>
        </div>

        <!-- Success State -->
        <div id="success" class="hidden">
            <div class="icon icon-success">&#10004;</div>
            <h1>Authentification reussie!</h1>
            <p>Votre compte Teamleader a ete connecte avec succes. Vous pouvez fermer cette fenetre.</p>
            <button class="btn btn-primary" onclick="closeWindow()">Fermer la fenetre</button>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden">
            <div class="icon icon-error">&#10006;</div>
            <h1>Erreur d'authentification</h1>
            <p id="error-message">Une erreur est survenue lors de l'authentification.</p>
            <div id="error-details" class="error-details hidden"></div>
            <button class="btn btn-secondary" onclick="window.location.href='/'">Retour</button>
        </div>

        <!-- Manual Code Entry State -->
        <div id="manual" class="hidden">
            <div class="icon icon-manual">&#128203;</div>
            <h1>Finaliser la connexion</h1>
            <p>Cliquez sur le bouton ci-dessous pour finaliser la connexion depuis votre reseau local:</p>
            <div class="code-container">
                <a id="redirect-link" href="#" class="btn btn-primary" style="display: inline-block; margin-bottom: 12px;">
                    Finaliser la connexion
                </a>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    Si le bouton ne fonctionne pas, copiez ce lien et ouvrez-le dans votre navigateur:
                </p>
                <input type="text" id="code-input" class="code-input" readonly style="font-size: 11px;">
                <button class="btn btn-secondary" onclick="copyCode()">Copier le lien</button>
            </div>
            <div id="copied-message" class="copied">Lien copie dans le presse-papiers!</div>

            <!-- Zone d'entrÃ©e manuelle du code -->
            <div class="code-container" style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                <p style="font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600;">
                    Ou entrez le code OAuth manuellement:
                </p>
                <input type="text" id="manual-code-input" class="code-input" placeholder="Collez le code OAuth ici..." style="font-size: 12px; margin-bottom: 12px;">
                <div style="display: flex; gap: 8px; justify-content: center;">
                    <button class="btn btn-primary" onclick="submitManualCode()">Envoyer le code</button>
                </div>
                <p id="manual-status" style="font-size: 12px; color: #666; margin-top: 8px;"></p>
            </div>
        </div>
    </div>

    <script>
        // Configuration - URLs des serveurs (dev + production)
        const SERVERS = [
            { name: 'localhost', url: 'http://localhost:3000/api/oauth/teamleader/callback' },
            { name: 'production', url: 'http://10.0.0.3:3000/api/oauth/teamleader/callback' }
        ];
        const LOCAL_SERVER_IP = '10.0.0.3'; // Pour le lien manuel
        const TIMEOUT_MS = 3000;

        // Parse query parameters
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                code: params.get('code'),
                state: params.get('state'),
                error: params.get('error'),
                errorDescription: params.get('error_description')
            };
        }

        // Show a specific state
        function showState(stateId) {
            ['loading', 'success', 'error', 'manual'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(stateId).classList.remove('hidden');
        }

        // Show error message
        function showError(message, details) {
            document.getElementById('error-message').textContent = message;
            if (details) {
                const detailsEl = document.getElementById('error-details');
                detailsEl.textContent = details;
                detailsEl.classList.remove('hidden');
            }
            showState('error');
        }

        // Show manual code entry with redirect link
        function showManualMode(code) {
            const callbackUrl = `http://${LOCAL_SERVER_IP}:3000/api/oauth/teamleader/callback?code=${encodeURIComponent(code)}`;
            document.getElementById('redirect-link').href = callbackUrl;
            document.getElementById('code-input').value = callbackUrl;
            showState('manual');
        }

        // Copy code to clipboard
        function copyCode() {
            const codeInput = document.getElementById('code-input');
            codeInput.select();
            codeInput.setSelectionRange(0, 99999); // For mobile

            try {
                navigator.clipboard.writeText(codeInput.value).then(() => {
                    const copiedMsg = document.getElementById('copied-message');
                    copiedMsg.classList.add('show');
                    setTimeout(() => copiedMsg.classList.remove('show'), 3000);
                });
            } catch (err) {
                // Fallback for older browsers
                document.execCommand('copy');
                const copiedMsg = document.getElementById('copied-message');
                copiedMsg.classList.add('show');
                setTimeout(() => copiedMsg.classList.remove('show'), 3000);
            }
        }

        // Submit manual code
        async function submitManualCode() {
            const manualInput = document.getElementById('manual-code-input');
            const statusEl = document.getElementById('manual-status');
            const code = manualInput.value.trim();

            if (!code) {
                statusEl.textContent = 'Veuillez entrer un code';
                statusEl.style.color = '#c62828';
                return;
            }

            statusEl.textContent = 'Envoi en cours...';
            statusEl.style.color = '#666';

            // Try all servers
            for (const server of SERVERS) {
                try {
                    statusEl.textContent = `Tentative ${server.name}...`;
                    const result = await tryServer(server.url, code);

                    if (result.success) {
                        statusEl.textContent = 'Connexion reussie!';
                        statusEl.style.color = '#2e7d32';
                        showState('success');
                        return;
                    }
                } catch (err) {
                    console.log(`Failed with ${server.name}:`, err);
                }
            }

            statusEl.textContent = 'Echec de connexion. Verifiez que le serveur est accessible.';
            statusEl.style.color = '#c62828';
        }

        // Close window
        function closeWindow() {
            if (window.opener) {
                window.opener.postMessage({ type: 'teamleader-oauth-success' }, '*');
                window.close();
            } else {
                window.close();
            }
        }

        // Try to send code to a specific server
        async function tryServer(serverUrl, code) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

            try {
                const response = await fetch(serverUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Erreur serveur: ' + response.status);
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Echec');
                }
                return { success: true };
            } catch (err) {
                clearTimeout(timeoutId);
                return { success: false, error: err };
            }
        }

        // Send code to local application - try all servers
        async function sendCodeToLocalApp(code) {
            console.log('Trying to connect to servers...');

            for (const server of SERVERS) {
                console.log(`Trying ${server.name}: ${server.url}`);
                const result = await tryServer(server.url, code);

                if (result.success) {
                    console.log(`Success with ${server.name}!`);
                    showState('success');
                    // Notify parent window if in popup
                    if (window.opener) {
                        window.opener.postMessage({ type: 'teamleader-oauth-success' }, '*');
                        setTimeout(() => window.close(), 2000);
                    }
                    return;
                }
                console.log(`Failed with ${server.name}:`, result.error?.message);
            }

            // All servers failed - show manual mode
            console.log('All servers failed - showing manual mode');
            showManualMode(code);
        }

        // Main initialization
        function init() {
            const params = getQueryParams();

            // Check for OAuth error
            if (params.error) {
                let errorMessage = 'Erreur d\'authentification Teamleader';

                switch (params.error) {
                    case 'access_denied':
                        errorMessage = 'Acces refuse. Vous avez refuse l\'autorisation.';
                        break;
                    case 'invalid_scope':
                        errorMessage = 'Portee invalide. Les permissions demandees ne sont pas valides.';
                        break;
                    case 'server_error':
                        errorMessage = 'Erreur serveur Teamleader. Veuillez reessayer plus tard.';
                        break;
                    default:
                        errorMessage = params.errorDescription || 'Une erreur est survenue.';
                }

                showError(errorMessage, params.error !== 'access_denied' ? `Code erreur: ${params.error}` : null);
                return;
            }

            // Check for authorization code
            if (!params.code) {
                showError('Aucun code d\'autorisation recu', 'Le parametre "code" est manquant dans l\'URL.');
                return;
            }

            // Try to send code to local application
            sendCodeToLocalApp(params.code);
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
